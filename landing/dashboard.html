<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - StyleMCP</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#0a0a0b;--bg-elevated:#141416;--bg-card:#1a1a1e;--border:#2a2a2e;--text:#fafafa;--text-muted:#a1a1aa;--accent:#6366f1;--accent-hover:#818cf8;--green:#22c55e;--yellow:#eab308;--red:#ef4444}
    body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;-webkit-font-smoothing:antialiased}

    .layout{display:flex;min-height:100vh}
    .sidebar{width:240px;background:var(--bg-elevated);border-right:1px solid var(--border);padding:24px;position:fixed;height:100vh}
    .sidebar-logo{font-weight:700;font-size:1.25rem;color:var(--text);text-decoration:none;display:flex;align-items:center;gap:8px;margin-bottom:32px}
    .logo-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--accent) 0%,#a855f7 100%);border-radius:8px;display:flex;align-items:center;justify-content:center}

    .nav-link{display:flex;align-items:center;gap:12px;padding:10px 12px;color:var(--text-muted);text-decoration:none;font-size:0.9rem;border-radius:8px;margin-bottom:4px;transition:all 0.2s}
    .nav-link:hover{background:var(--bg-card);color:var(--text)}
    .nav-link.active{background:var(--accent);color:white}
    .nav-link svg{width:18px;height:18px}

    .sidebar-footer{position:absolute;bottom:24px;left:24px;right:24px}
    .user-info{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-card);border-radius:8px;margin-bottom:12px}
    .user-avatar{width:36px;height:36px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600}
    .user-email{font-size:0.85rem;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .btn-logout{display:block;width:100%;padding:10px;background:transparent;border:1px solid var(--border);color:var(--text-muted);border-radius:8px;font-size:0.9rem;cursor:pointer;transition:all 0.2s}
    .btn-logout:hover{background:var(--bg-card);color:var(--text)}

    .main{flex:1;margin-left:240px;padding:32px 48px}
    .page-header{margin-bottom:32px}
    .page-header h1{font-size:1.75rem;font-weight:700;margin-bottom:8px}
    .page-header p{color:var(--text-muted)}

    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:32px}
    @media(max-width:1200px){.stats-grid{grid-template-columns:repeat(2,1fr)}}

    .stat-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:24px}
    .stat-label{font-size:0.85rem;color:var(--text-muted);margin-bottom:8px}
    .stat-value{font-size:2rem;font-weight:700}
    .stat-value.green{color:var(--green)}
    .stat-value.yellow{color:var(--yellow)}
    .stat-value.red{color:var(--red)}
    .stat-sub{font-size:0.85rem;color:var(--text-muted);margin-top:4px}

    .card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:24px;margin-bottom:24px}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .card-title{font-size:1.1rem;font-weight:600}

    .api-key-box{display:flex;align-items:center;gap:12px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:8px;padding:12px 16px}
    .api-key{font-family:'JetBrains Mono',monospace;font-size:0.9rem;flex-grow:1}
    .api-key.hidden{color:var(--text-muted)}
    .btn-icon{background:transparent;border:none;color:var(--text-muted);cursor:pointer;padding:8px;border-radius:6px;transition:all 0.2s}
    .btn-icon:hover{background:var(--bg-card);color:var(--text)}

    .progress-bar{height:8px;background:var(--bg-elevated);border-radius:4px;overflow:hidden;margin-top:16px}
    .progress-fill{height:100%;background:var(--accent);border-radius:4px;transition:width 0.3s}
    .progress-fill.warning{background:var(--yellow)}
    .progress-fill.danger{background:var(--red)}

    .tier-badge{display:inline-block;padding:4px 12px;border-radius:50px;font-size:0.8rem;font-weight:600;text-transform:uppercase}
    .tier-badge.free{background:rgba(161,161,170,0.2);color:var(--text-muted)}
    .tier-badge.pro{background:rgba(99,102,241,0.2);color:var(--accent)}
    .tier-badge.team{background:rgba(168,85,247,0.2);color:#a855f7}
    .tier-badge.enterprise{background:rgba(34,197,94,0.2);color:var(--green)}

    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border-radius:8px;font-weight:500;font-size:0.9rem;text-decoration:none;transition:all 0.2s;cursor:pointer;border:none}
    .btn-primary{background:var(--accent);color:white}
    .btn-primary:hover{background:var(--accent-hover)}
    .btn-secondary{background:var(--bg-elevated);color:var(--text);border:1px solid var(--border)}
    .btn-secondary:hover{border-color:var(--text-muted)}

    .empty-state{text-align:center;padding:48px;color:var(--text-muted)}

    .loading{display:flex;align-items:center;justify-content:center;min-height:400px}
    .spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    @media(max-width:768px){
      .sidebar{display:none}
      .main{margin-left:0;padding:24px}
      .stats-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="layout">
    <nav class="sidebar">
      <a href="/" class="sidebar-logo"><div class="logo-icon">S</div>StyleMCP</a>

      <a href="/dashboard.html" class="nav-link active">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
        Dashboard
      </a>
      <a href="/docs.html" class="nav-link">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
        Documentation
      </a>
      <a href="/pricing.html" class="nav-link">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
        Billing
      </a>

      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">?</div>
          <div class="user-email" id="userEmail">Loading...</div>
        </div>
        <button class="btn-logout" id="logoutBtn">Sign Out</button>
      </div>
    </nav>

    <main class="main">
      <div id="loading" class="loading">
        <div class="spinner"></div>
      </div>

      <div id="dashboard" style="display:none">
        <div class="page-header">
          <h1>Dashboard</h1>
          <p>Monitor your API usage and manage your account</p>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Current Plan</div>
            <div class="stat-value"><span class="tier-badge" id="tierBadge">Free</span></div>
            <div class="stat-sub" id="planActions"><a href="/pricing.html" style="color:var(--accent)">Upgrade</a></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Requests This Month</div>
            <div class="stat-value" id="usedCount">0</div>
            <div class="stat-sub">of <span id="limitCount">1,000</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Remaining</div>
            <div class="stat-value green" id="remainingCount">1,000</div>
            <div class="stat-sub">Resets <span id="resetDate">Feb 1</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Usage</div>
            <div class="stat-value" id="usagePercent">0%</div>
            <div class="progress-bar"><div class="progress-fill" id="progressBar" style="width:0%"></div></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">API Key</div>
            <button class="btn btn-secondary" id="regenerateBtn" style="display:none">Regenerate</button>
          </div>
          <div class="api-key-box">
            <code class="api-key hidden" id="apiKey">sk_â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</code>
            <button class="btn-icon" id="toggleKeyBtn" title="Show/Hide">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
            </button>
            <button class="btn-icon" id="copyKeyBtn" title="Copy">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
            </button>
          </div>
          <p style="margin-top:16px;color:var(--text-muted);font-size:0.9rem">Include this key in your API requests using the <code style="background:var(--bg-elevated);padding:2px 6px;border-radius:4px">X-Api-Key</code> header.</p>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Quick Start</div>
          </div>
          <div style="background:var(--bg-elevated);border-radius:8px;padding:16px;font-family:'JetBrains Mono',monospace;font-size:0.85rem;overflow-x:auto">
<pre style="margin:0">curl -X POST https://stylemcp.com/api/validate \
  -H "Content-Type: application/json" \
  -H "X-Api-Key: <span id="curlApiKey">YOUR_API_KEY</span>" \
  -d '{"text": "Click here to learn more!"}'</pre>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Configuration - Replace with your Supabase project details
    const SUPABASE_URL = 'https://orbliwjewqlnnutykozw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9yYmxpd2pld3Fsbm51dHlrb3p3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyNzE5MTEsImV4cCI6MjA4NDg0NzkxMX0.z2xrGw-3UqOHTQ28g7b83vBsavt9rDDP61MKo9I_ZSQ';

    // Initialize Supabase client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let userProfile = null;
    let apiKeyVisible = false;

    async function init() {
      // Check auth state
      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        window.location.href = '/login.html';
        return;
      }

      currentUser = session.user;

      // Get profile and usage
      await loadProfile();
      await loadUsage();

      // Show dashboard
      document.getElementById('loading').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
    }

    async function loadProfile() {
      const { data, error } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', currentUser.id)
        .single();

      if (error) {
        console.error('Error loading profile:', error);
        return;
      }

      userProfile = data;

      // Update UI
      document.getElementById('userEmail').textContent = currentUser.email;
      document.getElementById('userAvatar').textContent = currentUser.email.charAt(0).toUpperCase();

      const tierBadge = document.getElementById('tierBadge');
      tierBadge.textContent = data.tier.charAt(0).toUpperCase() + data.tier.slice(1);
      tierBadge.className = `tier-badge ${data.tier}`;

      document.getElementById('limitCount').textContent = data.monthly_request_limit.toLocaleString();
    }

    async function loadUsage() {
      const { data, error } = await supabase.rpc('get_usage_stats', {
        p_user_id: currentUser.id
      });

      if (error) {
        console.error('Error loading usage:', error);
        return;
      }

      const used = data.used || 0;
      const limit = data.limit || 1000;
      const remaining = data.remaining || limit;
      const percent = Math.round((used / limit) * 100);

      document.getElementById('usedCount').textContent = used.toLocaleString();
      document.getElementById('remainingCount').textContent = remaining.toLocaleString();
      document.getElementById('usagePercent').textContent = `${percent}%`;

      const progressBar = document.getElementById('progressBar');
      progressBar.style.width = `${percent}%`;
      if (percent >= 90) progressBar.classList.add('danger');
      else if (percent >= 75) progressBar.classList.add('warning');

      // Format reset date
      const resetDate = new Date(data.reset_date);
      document.getElementById('resetDate').textContent = resetDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

      // Update remaining color
      const remainingEl = document.getElementById('remainingCount');
      remainingEl.className = 'stat-value';
      if (remaining === 0) remainingEl.classList.add('red');
      else if (remaining < limit * 0.1) remainingEl.classList.add('yellow');
      else remainingEl.classList.add('green');
    }

    // Toggle API key visibility
    document.getElementById('toggleKeyBtn').addEventListener('click', () => {
      apiKeyVisible = !apiKeyVisible;
      const keyEl = document.getElementById('apiKey');
      const curlKeyEl = document.getElementById('curlApiKey');

      if (apiKeyVisible) {
        keyEl.textContent = userProfile.api_key;
        keyEl.classList.remove('hidden');
        curlKeyEl.textContent = userProfile.api_key;
      } else {
        keyEl.textContent = 'sk_â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
        keyEl.classList.add('hidden');
        curlKeyEl.textContent = 'YOUR_API_KEY';
      }
    });

    // Copy API key
    document.getElementById('copyKeyBtn').addEventListener('click', async () => {
      await navigator.clipboard.writeText(userProfile.api_key);
      alert('API key copied to clipboard');
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/';
    });

    // Upgrade to paid plan
    async function upgradeToPlan(tier) {
      try {
        const response = await fetch('/api/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: currentUser.id, tier })
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          alert('Failed to start checkout: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Checkout error:', error);
        alert('Failed to start checkout. Please try again.');
      }
    }

    // Open billing portal
    async function openBillingPortal() {
      try {
        const response = await fetch('/api/billing/portal', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: currentUser.id })
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          alert('Failed to open billing portal: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Portal error:', error);
        alert('Failed to open billing portal. Please try again.');
      }
    }

    // Update plan actions based on current tier
    function updatePlanActions() {
      const actionsEl = document.getElementById('planActions');
      if (!userProfile) return;

      if (userProfile.tier === 'free') {
        actionsEl.innerHTML = `
          <a href="#" onclick="upgradeToPlan('pro'); return false;" style="color:var(--accent)">Upgrade to Pro</a>
        `;
      } else if (userProfile.tier === 'pro') {
        actionsEl.innerHTML = `
          <a href="#" onclick="upgradeToPlan('team'); return false;" style="color:var(--accent)">Upgrade to Team</a> |
          <a href="#" onclick="openBillingPortal(); return false;" style="color:var(--text-muted)">Manage</a>
        `;
      } else if (userProfile.tier === 'team' || userProfile.tier === 'enterprise') {
        actionsEl.innerHTML = `
          <a href="#" onclick="openBillingPortal(); return false;" style="color:var(--accent)">Manage Subscription</a>
        `;
      }
    }

    // Check for checkout success/cancel
    function checkCheckoutStatus() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('checkout') === 'success') {
        alert('ðŸŽ‰ Subscription activated! Your plan has been upgraded.');
        window.history.replaceState({}, '', '/dashboard.html');
      } else if (params.get('checkout') === 'cancelled') {
        window.history.replaceState({}, '', '/dashboard.html');
      }
    }

    // Initialize
    checkCheckoutStatus();
    init().then(() => {
      updatePlanActions();
    });
  </script>
</body>
</html>
